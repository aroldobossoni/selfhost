---
# ============================================================================
# Infisical Secrets Integration
# ============================================================================
# Fetches Proxmox and OPNsense credentials from Infisical.
# ============================================================================

- name: Check if Infisical integration is enabled
  ansible.builtin.set_fact:
    _infisical_enabled: >-
      {{ infisical_enabled | default(true) and
         (infisical_client_id | default('') | length > 0) and
         (infisical_client_secret | default('') | length > 0) }}

- name: Fetch secrets from Infisical
  when: _infisical_enabled
  block:
    - name: Get Proxmox secrets from Infisical
      ansible.builtin.set_fact:
        _infisical_proxmox_secrets: >-
          {{ lookup('infisical.vault.read_secrets',
             auth_method='universal-auth',
             universal_auth_client_id=infisical_client_id,
             universal_auth_client_secret=infisical_client_secret,
             project_id=infisical_project_id,
             path=infisical_proxmox_path,
             env_slug=infisical_env_slug,
             url=infisical_url) }}
      delegate_to: localhost
      no_log: true

    - name: Set Proxmox credentials from Infisical
      ansible.builtin.set_fact:
        proxmox_api_token_id: >-
          {{ _infisical_proxmox_secrets[infisical_proxmox_token_id_key] | default(proxmox_api_token_id) }}
        proxmox_api_token_secret: >-
          {{ _infisical_proxmox_secrets[infisical_proxmox_token_secret_key] | default(proxmox_api_token_secret) }}
      no_log: true
      when: _infisical_proxmox_secrets is defined

    - name: Get OPNsense secrets from Infisical
      ansible.builtin.set_fact:
        _infisical_opnsense_secrets: >-
          {{ lookup('infisical.vault.read_secrets',
             auth_method='universal-auth',
             universal_auth_client_id=infisical_client_id,
             universal_auth_client_secret=infisical_client_secret,
             project_id=infisical_project_id,
             path=infisical_opnsense_path,
             env_slug=infisical_env_slug,
             url=infisical_url) }}
      delegate_to: localhost
      no_log: true
      when: infisical_opnsense_path is defined and infisical_opnsense_path | length > 0

    - name: Set OPNsense credentials from Infisical
      ansible.builtin.set_fact:
        opnsense_api_key: >-
          {{ _infisical_opnsense_secrets[infisical_opnsense_api_key_key] | default(opnsense_api_key) }}
        opnsense_api_secret: >-
          {{ _infisical_opnsense_secrets[infisical_opnsense_api_secret_key] | default(opnsense_api_secret) }}
      no_log: true
      when: _infisical_opnsense_secrets is defined

- name: Display Infisical integration status
  vars:
    _proxmox_status: "{{ 'loaded' if proxmox_api_token_id | length > 0 else 'not found' }}"
    _opnsense_status: "{{ 'loaded' if opnsense_api_key | default('') | length > 0 else 'not configured' }}"
  ansible.builtin.debug:
    msg: >-
      Infisical integration: {{ 'enabled' if _infisical_enabled else 'disabled' }}{%- if _infisical_enabled %}
      | Proxmox: {{ _proxmox_status }} | OPNsense: {{ _opnsense_status }}{%- endif %}
